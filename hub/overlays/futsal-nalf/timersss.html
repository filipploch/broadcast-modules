<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timer Overlay</title>
    <link rel="stylesheet" href="/overlays/css/futsal-nalf/timer.css">
</head>
<body>
    <div class="timer-container">
        <div class="timer-display" id="timer">00:00</div>
        <div class="timer-label" id="label">CZAS GRY</div>
        <div class="connection-status" id="status">üî¥ Disconnected</div>
    </div>

    <!-- WebSocket Client -->
    <script src="/overlays/js/wsClient.js"></script>
    
    <!-- Timer Logic -->
    <script>
        // Initialize WebSocket client
        const ws = new WSClient({
            overlayId: 'timer-overlay-main',  // Unique ID for this overlay instance
            overlayName: 'Timer Overlay',
            moduleOwner: 'futsal-nalf',
            subscribeClasses: ['timer_update_receiver'],  // ‚úÖ Subscribe to timer updates
            debug: true  // Enable debug logging
        });

        // DOM elements
        const timerEl = document.getElementById('timer');
        const labelEl = document.getElementById('label');
        const statusEl = document.getElementById('status');

        // ‚úÖ Handle timer_updated messages from timer-plugin
        ws.on('timer_updated', (payload, fullMessage) => {
            console.log('‚è±Ô∏è  Timer updated:', payload);
            
            // Update time display
            if (payload.elapsed_formatted) {
                timerEl.textContent = payload.elapsed_formatted;
            }
            
            // Update label
            if (payload.timer_name) {
                labelEl.textContent = payload.timer_name.toUpperCase();
            }
            
            // Update state (running/paused/stopped)
            timerEl.dataset.state = payload.state || 'stopped';
            
            // Warning state (last 10 seconds)
            if (payload.limit && payload.elapsed) {
                const remaining = payload.limit - payload.elapsed;
                if (remaining <= 10 && remaining > 0) {
                    timerEl.classList.add('warning');
                } else {
                    timerEl.classList.remove('warning');
                }
            }
        });

        // ‚úÖ Handle timer events (started, paused, reset)
        ws.on('timer_event', (payload, fullMessage) => {
            console.log('üì¢ Timer event:', payload);
            
            const event = payload.event;
            
            switch (event) {
                case 'started':
                    timerEl.classList.add('running');
                    timerEl.classList.remove('paused');
                    break;
                    
                case 'paused':
                    timerEl.classList.add('paused');
                    timerEl.classList.remove('running');
                    break;
                    
                case 'reset':
                    timerEl.classList.remove('running', 'paused', 'warning');
                    timerEl.textContent = '00:00';
                    break;
                    
                case 'limit_reached':
                    timerEl.classList.add('limit-reached');
                    // Optional: Play sound, flash screen, etc.
                    break;
            }
        });

        // Connection status updates
        ws.onConnect(() => {
            statusEl.textContent = 'üü¢ Connected';
            statusEl.className = 'connection-status connected';
        });

        ws.onDisconnect(() => {
            statusEl.textContent = 'üî¥ Disconnected';
            statusEl.className = 'connection-status disconnected';
        });

        // Connect on page load
        ws.connect();

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            ws.disconnect();
        });
    </script>
</body>
</html>