<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Overlay - Futsal NALF</title>
    <link rel="stylesheet" href="/overlays/futsal-nalf/css/main.css">
    <link rel="stylesheet" href="/overlays/futsal-nalf/css/scoreboard.css">
    <link rel="stylesheet" href="/overlays/futsal-nalf/css/timer.css">
</head>
<body>
    <div id="connection-status" class="connected"></div>
    <div id="scoreboard-container">
        <div id="top-scoreboard-container" class="scoreboard-row">
            <div></div>
            <div id="home-team-fouls" class="team-fouls">Â·Â·Â·Â·Â·</div>
            <div></div>
            <div></div>
            <div id="away-team-fouls" class="team-fouls">Â·Â·Â·Â·Â·</div>
        </div>
        <div id="main-scoreboard-container" class="scoreboard-row">
            <div id="main-timer-display">00:00</div>
            <div id="home-team-name" class="team-name">TEA</div>
            <div id="home-team-score" class="team-score">1</div>
            <div id="away-team-score" class="team-score">1</div>
            <div id="away-team-name" class="team-name">TEB</div>
        </div>
        <div id="bottom-scoreboard-container" class="scoreboard-row">
            <div></div>
            <div id="home-team-penalty-timer-container" class="penalty-timer-container">
                <div class="penalty-timer">1:15</div>
            </div>
            <div></div>
            <div></div>
            <div id="away-team-penalty-timer-container" class="penalty-timer-container">
                <div class="penalty-timer">0:35</div>
            </div>
        </div>
    </div>

    <script src="/overlays/futsal-nalf/js/formatters.js"></script>
    
    <script>
        // WebSocket z rejestracjÄ… jako overlay + subskrypcja timer
        const overlayId = 'overlay-timer-' + Math.random().toString(36).substr(2, 9);
        const ws = new WebSocket(`ws://${window.location.hostname}:${window.location.port}/ws`);
        
        const display = document.getElementById('main-timer-display');
        // const stateEl = document.getElementById('timer-state');
        const statusEl = document.getElementById('connection-status');
        
        let registered = false;
        
        ws.onopen = () => {
            console.log('âœ… Connected to HUB');
            statusEl.classList.add('connected');
            
            // 1. REJESTRACJA jako overlay
            ws.send(JSON.stringify({
                type: 'register',
                from: overlayId,
                to: 'hub',
                payload: {
                    id: overlayId,
                    component_type: 'overlay',
                    type: 'overlay'
                }
            }));
        };
        
        ws.onclose = () => {
            console.log('âŒ Disconnected from HUB');
            statusEl.classList.remove('connected');
            setTimeout(() => location.reload(), 3000);
        };
        
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log('ğŸ“¨ Received:', msg.type, msg);
            
            // Po rejestracji â†’ subskrybuj timer
            if (msg.type === 'registered' && !registered) {
                registered = true;
                console.log('âœ… Registered! Now subscribing to timer...');
                
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    from: overlayId,
                    to: 'hub',
                    payload: {
                        class: ['timer', 'timer_update_receiver']  // Subskrybuj klasÄ™ "timer"
                    }
                }));
            }
            
            // Po subskrypcji
            if (msg.type === 'subscribed') {
                console.log('âœ… Subscribed to classes!');
            }
            
            // Odbieraj timer_updated
            if (msg.type === 'timer_updated') {
                const data = msg.payload || msg.data;
                
                // Update display
                const formatted = FutsalFormatters.formatElapsedTime(data.elapsed_time);
                display.textContent = formatted;
                // stateEl.textContent = (data.state || 'stopped').toUpperCase();
                
                // Update styling
                display.classList.remove('timer-running', 'timer-paused', 'timer-stopped');
                display.classList.add('timer-' + data.state);
                
                console.log(`â±ï¸ Timer: ${formatted} [${data.state}]`);
            }
        };
    </script>
	<script src="/overlays/futsal-nalf/js/penalty-timers-observers.js"></script>
</body>
</html>
